<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Th·ªëng K√™ Chi Ti·∫øt - Trucking Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f4f6f9;
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
        }

        .navbar {
            background-color: #333;
            overflow: hidden;
            border-radius: 8px 8px 0 0;
            margin-bottom: 20px;
        }

        .navbar a {
            float: left;
            display: block;
            color: #f2f2f2;
            text-align: center;
            padding: 14px 16px;
            text-decoration: none;
            font-weight: bold;
        }

        .navbar a:hover {
            background-color: #ddd;
            color: black;
        }

        .navbar a.active {
            background-color: #007bff;
            color: white;
        }

        h2,
        h3 {
            color: #333;
            margin-bottom: 15px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            padding: 20px;
            border-radius: 8px;
            color: white;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .card h3 {
            margin: 0;
            font-size: 28px;
            font-weight: bold;
        }

        .card p {
            margin: 5px 0 0;
            font-size: 13px;
            opacity: 0.9;
            text-transform: uppercase;
        }

        .bg-blue {
            background: linear-gradient(45deg, #4099ff, #73b4ff);
        }

        .bg-green {
            background: linear-gradient(45deg, #2ed8b6, #59e0c5);
        }

        .bg-red {
            background: linear-gradient(45deg, #FF5370, #ff869a);
        }

        .bg-orange {
            background: linear-gradient(45deg, #FFB64D, #ffcb80);
        }

        .details-section {
            margin-top: 30px;
            border-top: 2px solid #eee;
            padding-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 14px;
        }

        th,
        td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background-color: #f8f9fa;
            color: #555;
            font-weight: bold;
        }

        .text-right {
            text-align: right;
        }

        tr:hover {
            background-color: #f9f9f9;
        }

        .chart-container {
            position: relative;
            height: 350px;
            width: 100%;
            margin-bottom: 20px;
        }

        .btn-detail {
            background-color: #17a2b8;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 950px;
            border-radius: 8px;
            position: relative;
        }

        .close {
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #aaa;
        }

        .modal-title {
            color: #007bff;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            margin-top: 0;
        }

        .status-paid {
            color: green;
            font-weight: bold;
        }

        .status-unpaid {
            color: red;
            font-weight: bold;
        }
    </style>
</head>

<body>

    <div class="container">
        <div class="navbar">
            <a href="index.html">üè† Dashboard</a>
            <a href="stats.html" class="active">üìä B√°o C√°o & Th·ªëng K√™</a>
        </div>

        <h2>üìä T·ªïng Quan Ho·∫°t ƒê·ªông</h2>
        <div class="stats-grid">
            <div class="card bg-blue">
                <h3 id="stat-count">0</h3>
                <p>T·ªïng Booking</p>
            </div>
            <div class="card bg-green">
                <h3 id="stat-revenue">0 ƒë</h3>
                <p>T·ªïng Doanh Thu</p>
            </div>
            <div class="card bg-red">
                <h3 id="stat-cost">0 ƒë</h3>
                <p>T·ªïng Chi Ph√≠</p>
            </div>
            <div class="card bg-orange">
                <h3 id="stat-profit">0 ƒë</h3>
                <p>L·ª£i Nhu·∫≠n R√≤ng</p>
            </div>
        </div>

        <div class="chart-container"><canvas id="financeChart"></canvas></div>

        <div class="details-section">
            <h3>üèÜ Hi·ªáu Qu·∫£ Kinh Doanh Theo Nh√† Xe</h3>
            <table>
                <thead>
                    <tr>
                        <th>T√™n Nh√† Xe</th>
                        <th class="text-right">S·ªë Chuy·∫øn</th>
                        <th class="text-right">T·ªïng Thu</th>
                        <th class="text-right">T·ªïng Chi</th>
                        <th class="text-right">L·ª£i Nhu·∫≠n</th>
                        <th class="text-right">T·ª∑ su·∫•t</th>
                        <th style="text-align: center;">Chi ti·∫øt</th>
                    </tr>
                </thead>
                <tbody id="carrier-table-body"></tbody>
            </table>
        </div>
    </div>

    <div id="detailModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeDetailModal()">&times;</span>
            <h3 class="modal-title" id="modal-header">Chi Ti·∫øt Giao D·ªãch</h3>
            <table>
                <thead>
                    <tr>
                        <th>Ng√†y</th>
                        <th>Booking</th>
                        <th>S·ªë Cont</th>
                        <th class="text-right">Thu</th>
                        <th class="text-right">Chi</th>
                        <th style="text-align: center;">Tr·∫°ng th√°i</th>
                        <th>Ghi ch√∫</th>
                    </tr>
                </thead>
                <tbody id="detail-table-body"></tbody>
            </table>
        </div>
    </div>

    <script>
        const API_URL = '/api/trucking';
        let globalData = [];
        const formatCurrency = (amount) => new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount);
        const formatDate = (isoString) => isoString ? new Date(isoString).toLocaleDateString('vi-VN') : '';

        async function loadStats() {
            try {
                const response = await fetch(API_URL);
                globalData = await response.json();
                let totalRevenue = 0, totalCost = 0, carrierStats = {};
                globalData.forEach(item => {
                    const rev = Number(item.revenue) || 0, cost = Number(item.cost) || 0;
                    totalRevenue += rev; totalCost += cost;
                    const cName = item.carrier || "Ch∆∞a x√°c ƒë·ªãnh";
                    if (!carrierStats[cName]) carrierStats[cName] = { count: 0, revenue: 0, cost: 0 };
                    carrierStats[cName].count++; carrierStats[cName].revenue += rev; carrierStats[cName].cost += cost;
                });
                document.getElementById('stat-count').innerText = globalData.length;
                document.getElementById('stat-revenue').innerText = formatCurrency(totalRevenue);
                document.getElementById('stat-cost').innerText = formatCurrency(totalCost);
                document.getElementById('stat-profit').innerText = formatCurrency(totalRevenue - totalCost);
                renderChart(totalRevenue, totalCost, totalRevenue - totalCost);
                renderCarrierTable(carrierStats);
            } catch (error) { console.error(error); }
        }

        function renderCarrierTable(statsObj) {
            const tbody = document.getElementById('carrier-table-body');
            tbody.innerHTML = "";
            Object.keys(statsObj).map(key => ({ name: key, ...statsObj[key] }))
                .sort((a, b) => (b.revenue - b.cost) - (a.revenue - a.cost))
                .forEach(c => {
                    const profit = c.revenue - c.cost;
                    const margin = c.revenue > 0 ? ((profit / c.revenue) * 100).toFixed(1) + '%' : '0%';
                    tbody.innerHTML += `<tr>
                    <td style="font-weight: bold;">${c.name}</td>
                    <td class="text-right">${c.count}</td>
                    <td class="text-right" style="color: green;">${formatCurrency(c.revenue)}</td>
                    <td class="text-right" style="color: red;">${formatCurrency(c.cost)}</td>
                    <td class="text-right" style="font-weight: bold;">${formatCurrency(profit)}</td>
                    <td class="text-right">${margin}</td>
                    <td style="text-align: center;"><button class="btn-detail" onclick="viewDetails('${c.name}')">üëÅÔ∏è Xem</button></td>
                </tr>`;
                });
        }

        function viewDetails(carrierName) {
            document.getElementById('modal-header').innerText = `Chi Ti·∫øt Giao D·ªãch: ${carrierName}`;
            const tbody = document.getElementById('detail-table-body');
            tbody.innerHTML = "";
            globalData.filter(item => item.carrier === carrierName).forEach(item => {
                const statusText = item.paymentStatus === 'paid' ? '<span class="status-paid">ƒê√£ TT</span>' : '<span class="status-unpaid">Ch∆∞a TT</span>';
                tbody.innerHTML += `<tr>
                <td>${formatDate(item.createdAt)}</td>
                <td style="font-weight:bold;">${item.booking}</td>
                <td>${item.containers ? item.containers.length : 0}</td>
                <td class="text-right">${formatCurrency(item.revenue)}</td>
                <td class="text-right">${formatCurrency(item.cost)}</td>
                <td style="text-align:center;">${statusText}</td>
                <td style="font-size:12px; color:#666;">${item.notes || ''}</td>
            </tr>`;
            });
            document.getElementById('detailModal').style.display = "block";
        }

        function closeDetailModal() { document.getElementById('detailModal').style.display = "none"; }
        window.onclick = (e) => { if (e.target == document.getElementById('detailModal')) closeDetailModal(); }

        function renderChart(revenue, cost, profit) {
            const ctx = document.getElementById('financeChart').getContext('2d');
            if (window.myChart) window.myChart.destroy();
            window.myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Doanh Thu', 'Chi Ph√≠', 'L·ª£i Nhu·∫≠n'],
                    datasets: [{
                        data: [revenue, cost, profit],
                        backgroundColor: ['rgba(46, 216, 182, 0.7)', 'rgba(255, 83, 112, 0.7)', 'rgba(255, 182, 77, 0.7)'],
                        borderWidth: 1
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });
        }
        loadStats();
    </script>
</body>

</html>
